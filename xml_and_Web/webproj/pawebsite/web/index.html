<!DOCTYPE html>
<html>
	<head>
		<link href="style.css" rel="stylesheet" type="text/css"/>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>PA international geolog website</title>
		<!-- google map stuff -->
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<!-- load jquery -->
		<script type="text/javascript" src="js/jquery-1.4.2.js"></script>
		<script type="text/javascript">
			var timeout; // This variable is used for changing between http not ready timeout and polling timeout
			var markerXML = null; //This variable is to hold the markers as output from the web-site transformer
	        var deviceMarkers = [];
			var map = null;
			//Initialize when document is ready
			function initialize() {
				loadTable();
				loadMap();
				// Start the poll timer
				timeout = window.setTimeout(pollServer, 6000);
			}

			//Load the transformed web-service output directly into the table div element
			function loadTable(){
				$('#devicesTable').load('devices');
			}

			//First time load of the map
			//TODO: Fix the initial zoom etc.
			function loadMap(){
				var myOptions = {
				zoom: 5,
				center: new google.maps.LatLng(9,54),
				mapTypeId: google.maps.MapTypeId.ROADMAP
				}

				map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
			}

			//Poll the server. This function is called at regular intervals to update the table and the map
			function pollServer() {
				loadTable();
				//Poll the server for markers
				$.get('devices?type=markers', processMarkers,"xml");
			}

			//Callback function for the marker AJAX call
			function processMarkers(data) {
				// obtain the array of markers and loop through it
				markerXML = data.documentElement.getElementsByTagName("marker");
				displayDeviceMarkers();
				// Re-start the timeout
				window.clearTimeout(timeout);
				timeout = window.setTimeout(pollServer, 6000);
			}

			function displayDeviceMarkers() {
				//Not function. How do we achieve this?
				//map.clearOverlays();
				for (var i = 0; i < markerXML.length; i++) {
						// obtain the attributes of each marker
						var lat = parseFloat(markerXML[i].getAttribute("lat"));
						var lng = parseFloat(markerXML[i].getAttribute("lon"));
						var id = markerXML[i].getAttribute("id");
						var label = markerXML[i].getAttribute("name");
						createDeviceMarker(new google.maps.LatLng(lat,lng),id);
				}
			}
			//Create a device marker
			  function createDeviceMarker(point,id) {

				var marker = new google.maps.Marker({map:map, position:point, title:id});
//				GEvent.addListener(marker, "click", function(point) {
//					map.setCenter(new GLatLng(marker.point.y,marker.point.x),10);
//				});
//				deviceMarkers[i] = marker;
//
//				i++;
//				map.addOverlay(marker);
//
//				//  ======  The new marker "mouseover" and "mouseout" listeners  ======
//				GEvent.addListener(marker,"mouseover", function() {
//				  showTooltip(marker);
//				});
//				GEvent.addListener(marker,"mouseout", function() {
//				  tooltip.style.visibility="hidden"
//				});
//			  }
			}
		</script>
	</head>
	<body onload="initialize()">
	<h1>Welcome to the PA geolog website</h1>
	<br/>
	<p>For a list of registered devices please select the below link</p>
	<a href="/paweb/devices">Devices</a>
	<table>
		<tr valign="top">
			<td>
				<div id="devicesTable">Loading table</div>
			</td>
			<td>
				<div id="map_canvas" style="width:500px; height:500px">Loading map</div>
			</td>
		</tr>
	</table>
	<div id="result"></div>
	<br/>
		<a href="http://localhost:8080/geolog/devices">
			<xsl:text>Show the table information as sent from the web-service</xsl:text>
		</a>
		<br/>
		<a href="http://localhost:8080/paweb/devices?type=kml">
			<xsl:text>Show the kml file to use for Google Earth display</xsl:text>
		</a>
		<br/>
		<a href="http://localhost:8080/paweb/devices?type=markers">
			<xsl:text>Show the marker information to use for Google Map display</xsl:text>
		</a>
	</body>
</html>
