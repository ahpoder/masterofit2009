<html>
<head>
<title>Chat client</title>
<script type="text/javascript" src="ajax.js"/>
<script type="text/javascript">
	var timeout;

	function switchName(){
		// Get the value of the chat field
		var name = document.getElementById('name').value;
		if (name=="") {
			// Show an error message if the field is blank;
			document.getElementById('msg').style.display="block";
			document.getElementById('msg').innerHTML = "Error! You cannot use a blank name"; 
		} else {
			document.getElementById('currentName').innerHTML = name; 
			document.getElementById('msg').innerHTML = "";
			document.getElementById('name').value = "";
		}
	}

	function switchChat(){
		// Get the value of the chat field
		var chat = document.getElementById('chat').value;
		if (chat=="") {
			// Show an error message if the field is blank;
			document.getElementById('msg').style.display="block";
			document.getElementById('msg').innerHTML = "Error! You cannot use a blank chat"; 
		} else {
			document.getElementById('currentChat').innerHTML = chat; 
			document.getElementById('msg').innerHTML = "";
			document.getElementById('chat').value = "";
			pollServer();
		}
	}

	function sendListItem(){
		// Get the value of the chat field
		var chat = document.getElementById('currentChat').innerHTML;
		// Get the value of the name field
		var name = document.getElementById('currentName').innerHTML;
		if (name=="" || chat=="") {
			// Show an error message if the field is blank;
			document.getElementById('msg').style.display="block";
			document.getElementById('msg').innerHTML = "Error! Please enter a name to identify yourself and a chat to join/create"; 
		} else {
			// Get the value into the input text field
			var text = document.getElementById('newItem').value;
			if(text==""){
				// Show an error message if the field is blank;
				document.getElementById('msg').style.display="block";
				document.getElementById('msg').innerHTML = "Error! You must have something to say";
			} else {
				document.getElementById('msg').innerHTML = "";
				if (http.readyState == 0 || http.readyState == 4) {
					sendRequest(encodeURI("http://" + location.host + "/ChatServer?chat=" + chat + "&name=" + name + "&text=" + text), serverResponse);
					document.getElementById('newItem').value = "";
				} else {
					window.clearTimeout(timeout);
					timeout = window.setTimeout(sendListItem, 500);
				}
			}
		}
	}

	// This function can be reused by both send chat and poll
	function serverResponse() {
		if (http.readyState == 4) {
			try {
				if (http.status == 200) {
					// Parse the repsonse and update the chat list
					
					// This is the <div id="chatTextList"> element that will contains the new elements
					var container = document.getElementById('chatTextList');
					
					var d = document.createElement("div");
					d.innerHTML = http.responseText;
					var u = d.getElementsByTagName("table")[0];

					container.innerHTML = "<table border=\"1\">" + u.innerHTML + "</table>";
					
					window.clearTimeout(timeout);
					window.setTimeout(pollServer, 3000);
				} else {
					alert("Error: " + http.status);
				}
			} catch (e) {
				alert(e);
			}
		}
	}
	
	function pollServer() {
		// Get the value of the name field
		var chat = document.getElementById('currentChat').innerHTML;
		if (chat != "") {
			if (http.readyState == 0 || http.readyState == 4) {
				sendRequest(encodeURI("http://" + location.host + "/ChatServer?chat=" + chat), serverResponse);

			} else {
				window.clearTimeout(timeout);
				timeout = window.setTimeout(pollServer, 500);
			}
		}
	}

	timeout = window.setTimeout(pollServer, 3000);
</script>
</head>
<body>
<table><tr><td>Current name:</td><td><div id="currentName"></div></td></tr>
<tr><td>Please enter your name:</td><td>
<input name="name" id="name" type="text" value=""/>
<input type="button" value="Set name" name="submit" onClick="javascript:switchName()"/>
</td></tr>
<tr><td>Current chat:</td><td><div id="currentChat"></div></td></tr>
<tr><td>Please enter the chat you wish to join:</td><td>
<input name="chat" id="chat" type="text" value=""/>
<input type="button" value="Set chat" name="submit" onClick="javascript:switchChat()"/>
</td></tr></table><br/>
This is a list of ongoing chats and their last update time:
<div id="ongoingChatList"/>
<br/>
Please enter the text you wish to add to the chat:
<input name="newItem" id="newItem" type="text" value=""/>
<input type="button" value="Add to chat" name="submit" onClick = "javascript:sendListItem()"/><br/><br/>
<div id="msg"></div>
<br/>
Chat list</br>
<div id="chatTextList"/>
</body>
</html>